var cem={loaded:false,debug:false,activePage:window.PaginaActual||window.paginaNoFix||'',planes:window.periodosPlanes||null,categories:window.categoriasPlanes||[],products:[],productSelected:null,itemsCart:[],event:'',loginState:null,cart:{items:[],orders:[],ordersChecked:[],steps:[{id:1,name:'Carro completo'},{id:2,name:'Identificación de usuario'},{id:3,name:'Pago iniciado'}]},init:function(){var self=this;self.loaded=true;if(self.gaLoaded()){ga('require','ec');}else{console.warn('gaLoaded','ga no está cargado.')}},gaLoaded:function(){return ga&&ga.loaded;},setLoginState:function(state){var self=this;self.loginState=state;},getLoginState:function(){var self=this;return self.loginState;},setOrderById:function(id){var self=this,orderChecked=self.cart.orders.find(function(order){return order.id==id;});if(orderChecked)self.cart.ordersChecked.push(orderChecked);},getOrderList:function(){return $.ajax({url:'https://administracion.donweb.com/apiv3/compras/ordenDeCompra/obtenerListado/0/100?jsoncallback=?',dataType:'json',type:'GET'});},getItemFromCartById:function(id){var self=this;return self.cart.items.find(function(item){return item.id==id});},getCheckoutStepNameById:function(id){var self=this,result=self.cart.steps.find(function(step){return step.id==id})
return result&&result.name;},getCategoryNameById:function(id,plan){var self=this,result=self.categories.find(function(category){return category.id==id});if(plan&&id==26){result=result&&result.subcat&&result.subcat.find(function(category){return category.plan==plan});}
return result&&result.name;},getProductById:function(id){var self=this;return self.products.find(function(product){return product.id==id});},setProductById:function(id){var self=this,product=self.getProductById(id);self.productSelected=product;},setProducts:function(products){var self=this,isArray=$.isArray(products),isObject=$.isPlainObject(products),products=isObject?[products]:isArray?products:[];$.each(products,function(i,product){self.products.push(product);});},getPlanById:function(id){var self=this;return self.planes[id];},setEvent:function(event){var self=this;self.event=event;},getEvent:function(){var self=this,def=$.Deferred();switch(self.event){case 'eventProductsList':def=self.eventProductsList();break;case 'eventProductDetail':def=self.eventProductDetail();break;case 'eventOrderList':def=self.eventOrderList();break;default:def.resolve();}
return def.fail(function(error){console.warn(error)});},eventOrderList:function(){var self=this,def=$.Deferred();self.getOrderList().done(function(response){if(response&&response.jsonMC&&response.jsonMC.resultado&&response.jsonMC.respuesta.total>0){self.cart.orders=response.jsonMC.respuesta.items;var ordenes=window.ORDEN_COMPRA&&window.ORDEN_COMPRA.split(',');$.each(ordenes,function(i,orden){self.setOrderById(orden);});}else{def.reject('eventOrderList: No existen órdenes.');}});return def;},eventProductsList:function(products){var self=this,products=products||self.products,def=$.Deferred();if(products.length){self.debug&&console.log('eventProductsList','Impresión de productos');$.each(products,function(i,product){var category=self.getCategoryNameById(product.category,product.id);var data=$.extend({},product,{position:i,category:category});self.addImpression(data);});def.resolve();}else{def.reject('eventProductsList: No existen productos.');}
return def;},eventProductClic:function(id){var self=this,def=$.Deferred(),product=self.getProductById(id);if(product){var category=self.getCategoryNameById(product.category,product.id);var param=category&&{list:category};var data=$.extend({},product,{position:0,category:category});self.addProduct(data);self.setAction('click',param);self.debug&&console.log('eventProductClic','Clic en producto');def.resolve();}else{def.reject('eventProductClic: No existe producto.');}
return def;},eventProductDetail:function(){var self=this,product=self.productSelected,def=$.Deferred();if(product){var category=self.getCategoryNameById(product.category,product.id);var data=$.extend({},product,{position:0,category:category});self.addProduct(data);self.setAction('detail');self.debug&&console.log('eventProductDetail','Detalle de producto');def.resolve();}else{def.reject('eventProductDetail: No existe producto.');}
return def;},eventAddToCart:function(data){var self=this,product=self.getProductById(data.id),plan=self.getPlanById(data.id),periods=plan&&plan.periodos,periodSelected=periods[data.period],def=$.Deferred();if(plan&&product){var price=periodSelected&&periodSelected.valor;var quantity=parseInt(data.quantity);var category=self.getCategoryNameById(product.category,product.id);var variant=data.variant||undefined;if(periodSelected&&periodSelected.descuentoPromocionalPeriodo){price=(parseFloat(price)-parseFloat(periodSelected.descuentoPromocionalPeriodo)).toFixed(2);}
if(data.price)price=(data.price).toFixed(2);self.addProduct({id:product.id,name:product.name,variant:variant,category:category,price:price,quantity:quantity});self.setAction('add');if(self.gaLoaded()){ga('send','event','CEM','Producto agregado al carro',product.id,{hitCallback:function(){def.resolve();}});}else{def.reject('ga: No está cargado.');}
self.debug&&console.log('eventAddToCart','Producto agregado al carro');}else{def.reject('eventAddToCart: No existe producto o plan');}
return def;},eventRemoveFromCart:function(id){var self=this,item=self.getItemFromCartById(id),def=$.Deferred();if(item){var category=self.getCategoryNameById(item.categoria,item.plan);var quantity=parseInt(item.cantidad);self.addProduct({id:item.plan,name:item.texto_producto,category:category,price:item.costo,quantity:quantity});self.setAction('remove');if(self.gaLoaded()){ga('send','event','CEM','Producto eliminado del carro',item.plan,{hitCallback:function(){def.resolve();}});}else{def.reject('ga: No está cargado.');}
self.debug&&console.log('eventRemoveItemFromCart','Producto eliminado del carro');}else{def.reject('eventRemoveItemFromCart: No existe producto');}
return def;},eventCheckoutStep:function(step){var self=this,step=$.isNumeric(step)&&parseInt(step),itemsCarro=self.cart.items,ordersChecked=self.cart.ordersChecked,def=$.Deferred();if(itemsCarro.length||ordersChecked.length){$.each(ordersChecked,function(i,order){$.each(order.articulos,function(i,articulo){var category=self.getCategoryNameById(articulo.categoriaProducto,articulo.plan);self.addProduct({id:articulo.plan,name:articulo.n_producto,category:category,price:articulo.importe,quantity:1});});});$.each(itemsCarro,function(i,item){var category=self.getCategoryNameById(item.categoria,item.plan);var quantity=parseInt(item.cantidad);self.addProduct({id:item.plan,name:item.texto_producto,category:category,price:item.costo,quantity:quantity});});if(step){var label=cem.getCheckoutStepNameById(step);self.setAction('checkout',{step:step});if(self.gaLoaded()){ga('send','event','CEM','Proceso de compra [Pasos]',label,{hitCallback:function(){def.resolve();}});}else{def.reject('ga: No está cargado.');}
self.debug&&console.log('eventCheckoutStep',label);def.resolve(step);}else{def.reject('eventCheckoutStep: No hay pasos de checkout');}}else{def.reject('eventCheckoutStep: No hay items en el carro');}
return def;},eventCheckoutOption:function(step,option){var self=this,step=$.isNumeric(step)&&parseInt(step),def=$.Deferred();if(step){self.setAction('checkout_option',{step:step,option:option});if(self.gaLoaded()){ga('send','event','CEM','Proceso de compra [Opciones]','Paso '+step+': '+option,{hitCallback:function(){def.resolve(step);}});}else{def.reject('ga: No está cargado.');}
self.debug&&console.log('eventCheckoutOption',option);}else{def.reject('eventCheckoutOption: No hay pasos de checkout');}
return def;},eventPromoClic:function(promo){var self=this,def=$.Deferred();if(promo&&(promo.id||promo.name)){self.addPromo({id:promo.id,name:promo.name,creative:promo.creative,position:promo.position});self.setAction('promo_click');if(self.gaLoaded()){var label=promo.id||promo.name;ga('send','event','CEM','Promo',label,{hitCallback:function(){def.resolve();}});}else{def.reject('ga: No está cargado.');}
self.debug&&console.log('eventProductClic','Clic en producto');}else{def.reject('eventPromoClic: No existe promo.');}
return def;},addImpression:function(product){var self=this;if(self.gaLoaded()&&product){ga('ec:addImpression',{id:product.id||'',name:product.name||'',list:product.list||'',brand:product.brand||'',category:product.category||'',variant:product.variant||'',position:product.position||0,price:product.price||''});self.debug&&console.log('ec:addImpression',product);}},addProduct:function(product){var self=this;if(self.gaLoaded()&&product){ga('ec:addProduct',{id:product.id||'',name:product.name||'',brand:product.brand||'',category:product.category||'',variant:product.variant||'',price:product.price||'',quantity:product.quantity||1,coupon:product.coupon||'',position:product.position||1});self.debug&&console.log('ec:addProduct',product);}},addPromo:function(product){var self=this;if(self.gaLoaded()&&product){ga('ec:addPromo',{id:product.id||'',name:product.name||'',creative:product.creative||'',position:product.position||''});self.debug&&console.log('ec:addPromo',product);}},setAction:function(value,param){var self=this,param=param||{};if(self.gaLoaded()){ga('ec:setAction',value,param);self.debug&&console.log('ec:setAction',value);}},addCrossSelling:function(add,planStr){var self=this,plan=(self.productSelected&&self.productSelected.id)||planStr,referrer=document.referrer,originArr=referrer&&referrer.split('/'),origin=originArr.length>=3?originArr[2]:'no-referrer',value=add?1:0,def=$.Deferred();origin=util.href.getAllQueryStrings().o||origin;if(ga.hasOwnProperty('loaded')&&ga.loaded){setTimeout(function(){def.resolve();},1000);ga('send','event','CROSS SELLING PAGE',plan,origin,value,{hitCallback:function(){def.resolve();}});}else{def.resolve();}
return def;}};